# pkg

Набор клиентов и хелперов для работы с внешними пакетами

[GODOC](http://localhost:6060/pkg/) проекта

### Структура проекта

- core/* - ядро приложения.
- providers/* - провайдеры и клиенты сторонних сервисов.
- tools/* - алгоритмы и хелперы.
- db - работа с реляционными СУБД.
- httpx - работа с протоколом HTTP (расширение библиотеки net/http).
 
#### Зависимости

1. Вложенные пакеты не могут зависеть от дочерних. Дочерние зависят от родительских.
2. core/* зависят только от std, 3rd party и tools/*.
3. tools/* зависят только от std и 3rd party. Не могут зависеть от пакетов внутренних пакетов проекта.
4. providers/* зависят только от std, 3rd party, core/* и tools/*.
5. db, httpx - такие же правила, как для providers/*

std - пакеты стандартной библиотеки.
3rd party - сторонние библиотеки.

#### Общие правила для пакетов

1. Пакет обязательно должен содержать в корне файл с точкой входа {package_name}.go с описанием интерфейса и godoc для пакета в целом.
2. Example тесты необходимо выделять в отдельный файл example_test.go для пакета или {name}_example_test.go для какого то отдельного файла {name}.go.
3. При добавлении пакета, расширяющего функционал стандартной или сторонней библиотеки, следует называть пакет как {original_package}x (x - Extension). 

#### Структура providers/{package_name}

Необходимо придерживаться следующей структуры пакета:

- {package_name}.go - содержит интерфейс и общее godoc описание пакета.
- config.go - определение структуры конфигурации, ключей и дефолтных значений конфигурации.
- config_viper.go - viper загрузчики конфигурации. Могут быть другие загрузчики, именуем по правилу config_{type}.go.
- client.go - дефолтная реализация клиента.
- double.go - тестовый двойник клиента (необязательно).
- model.go - DTO объекты и маперы для них (необязательно).

### Тулинг для разработки

```bash
go install golang.org/x/tools/cmd/goimports@latest
go install github.com/daixiang0/gci@latest
go install mvdan.cc/gofumpt@latest
```

### Перед использованием пакета

Установите переменные окружения:
```bash
GOSUMDB=off
GO111MODULE=on
GOPRIVATE=github.com/wal1251
```

Далее необходимо выпустить [токен](https://github.com/settings/tokens) и выполнить:

```bash
git config \
 --global \
 url."https://${user}:${personal_access_token}@github.com".insteadOf \
 "github.com"
```
или если [ssh ключи](https://github.com/settings/keys) добавлены:
```bash
git config \
 --global \
 url."git@github.com".insteadOf \
 "https://github.com"
```

### Установка пакета себе в проект

```bash
go get github.com/wal1251/pkg@<версия>
```

### Версионирование

[Правила версионирования](https://go.dev/doc/modules/version-numbers)

Важно соблюдать версионирование и сохранять совместимость для прошлых версий. Весь новый функционал выпускается только под новой версией.

### Запуск тестов
```bash
make test
```

### Запуск линтеров
```bash
make lint
```

### Документация
```bash
docker run -d --rm --name pkg-godoc-server -p 6060:6060 golang:latest bash -c "go install golang.org/x/tools/cmd/godoc@latest && godoc -http=:6060"
```

### TODO
- [x] Хостинг и деплой go doc сервера, добавить ссылку на go doc в readme
- [x] Общее описание структуры репозитория в readme
- [ ] Описание по интеграции репозитория с проектом
- [ ] Описание и схема зависимостей пакетов внутри репозитория
- [x] Добавить пакет kafka 
- [ ] Переосмыслить поисковый движок ES (более универсальный)
- [ ] Коллекции v2
- [ ] Taskman v2
- [ ] Перенести в пакет providers клиенты сервисов.
- [ ] Рефакторинг и перенос proxy.
- [x] Добавить моковые имплементации для провайдеров (кодогенерация).
- [ ] Проревьюить тесты с целью создания переиспользуемых тест сьютов.
- [x] Починить моконый UUID для тестов

### Проблемы и решения при использовании MySQL с [Gonkey](https://github.com/lamoda/gonkey):

1. **Загрузка фикстур**:
    - **Проблема**: Gonkey использует `TRUNCATE` для очистки таблицы перед загрузкой фикстуры, вызывая ошибки при
      наличии внешних ключей.
    - **Решение**: Отключение проверки внешних ключей (`SET GLOBAL FOREIGN_KEY_CHECKS=0`) позволяет обойти проблему.

2. **Запросы к БД в тестах**:
    - **Проблема**: Gonkey оборачивает запросы, находящиеся в блоке `dbQuery` в функцию `row_to_json`, доступную только
      в PostgreSQL, что приводит к сбоям тестов.
    - **Решение**: Не предоставлено; требуются изменения в Gonkey. [Issue](https://github.com/lamoda/gonkey/issues/84)